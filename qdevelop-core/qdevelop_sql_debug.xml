<?xml version="1.0" encoding="UTF-8"?>

<sql-config-debug>
  <poperty index="deliverOrdersSignInsert" explain="签收成功" connect="biz" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <param-formatter>
      <param key="uid" value="${user.uid}"></param>
    </param-formatter>
    <sql repeat="doid@orderid@signName@arrivalDate" repeat-split="@" repeat-concat="^" params="signName|arrivalDate|doid" is-select="false" tables="deliver_orders" fetch-zero-err="true">update deliver_orders set status=15,sign_name='$[signName]',arrival_date='$[arrivalDate]' where do_id='$[doid]'</sql>
    <sql include="batch-insert-deliver-orders-log" repeat="doid@operation@status@content" repeat-split="@" repeat-concat="^" is-select="false" tables="" fetch-zero-err="true"></sql>
  </poperty>
  <poperty index="zjs_deliver_select" connect="biz_R" cacheAble="false" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="false" is-select="true">
    <sql params="transport_order|status|ec_id_1|ec_id_2" is-select="true" tables="deliver_orders" fetch-zero-err="true">select do_id, transport_order,order_id,status,ec_id from deliver_orders where transport_order='$[transport_order]' and status=$[status] and ec_id &gt; $[ec_id_1] and ec_id &lt; $[ec_id_2] and 9=9</sql>
    <result-formatter>
      <table-cache table="express_company" targetKey="ec_id" fields="express_name"></table-cache>
    </result-formatter>
  </poperty>
  <poperty index="deliverOrderTransportOrdersUpdate" explain="修改发货单物流单号" connect="biz" depends="orderBillsNoUpdate" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql repeat="transportOrder@doId@ecName" repeat-split="@" repeat-concat="^" params="transportOrder|doId|transportOrder" is-select="false" tables="deliver_orders" fetch-zero-err="true">update deliver_orders set transport_order='$[transportOrder]' where do_id='$[doId]' and transport_order='$[transportOrder]'</sql>
  </poperty>
  <poperty index="dotransferidUpdate" explain="发货单物流单号修改" connect="biz" depends="orderBillsnoUpdate" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <param-formatter>
      <param key="uid" value="${user.uid}"></param>
    </param-formatter>
    <update-hook>
      <exec-debug></exec-debug>
    </update-hook>
    <sql repeat="doid@transferid" repeat-split="@" repeat-concat="^" params="transferid|status|doid" is-select="false" tables="deliver_orders" fetch-zero-err="true">update deliver_orders set transport_order='$[transferid]',status=$[status],backfill_time=NOW() where do_id='$[doid]'</sql>
    <sql repeat="doid" repeat-concat="^" params="transferid|status|doid" is-select="false" tables="deliver_orders" fetch-zero-err="true">update deliver_orders set transport_order='$[transferid]',status=$[status],backfill_time=NOW() where do_id='$[doid]'</sql>
  </poperty>
  <poperty index="orderBillsNoUpdate" explain="修改运单号" connect="order" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql repeat="transportOrder@doId@ecName" repeat-split="@" repeat-concat="^" params="transportOrder|ecName|doId" is-select="false" tables="order_shipments" fetch-zero-err="true">update order_shipments set bills_no='$[transportOrder]',ec_name='$[ecName]' where shipment_id='$[doId]'</sql>
  </poperty>
  <poperty index="ep_position_apply_interview_job!select" connect="ep_biz_R" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="false" is-select="true">
    <sql params="status|hour|hour" is-select="true" tables="ep_position_apply" fetch-zero-err="true">select eppa_id, apply_mobile, apply_name, apply_user_id, apply_time from ep_position_apply epa where status=$[status] and timestampdiff(hour, apply_time, now())=$[hour] and timestampdiff(hour, interview_time, now())=$[hour] and 9=9</sql>
  </poperty>
  <poperty index="deliver_falsed_batch_insert" connect="ep_biz_R" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql params="epba_id" is-select="false" tables="ep_balance_account_summary epbas, ep_balance_account_detail epbad" fetch-zero-err="true">update ep_balance_account_summary epbas, ep_balance_account_detail epbad set epbas.history_rebate=epbas.history_rebate + epbad.current_rebate, epbas.is_platform_amount=epbas.is_platform_amount + epbad.is_platform_amount, epbas.platform_amount=epbas.platform_amount + epbad.platform_amount, epbas.actual_debit=epbas.actual_debit + epbad.current_rebate + epbad.platform_amount, epbas.refund_amount=epbas.refund_amount + epbad.current_refund_amount, epbas.paid_account=epbas.paid_account + epbad.payable_account, epbas.cash_surplus=epbas.paid_account - epbas.actual_debit - epbas.refund_amount, epbas.recommend_history_rebate=epbas.recommend_history_rebate + epbad.recommend_current_rebate, epbas.work_days=epbad.current_work_days, epbas.is_rebate_finish=if(epbas.is_rebate_finish=1, epbas.is_rebate_finish, epbad.is_rebate_finish), epbas.balance_count=epbas.balance_count + 1, epbas.last_time=now(), epbad.finish_time=now() where epbas.eppa_id=epbad.eppa_id and epbad.status in (1,3) and epbad.epba_id='$[epba_id]'</sql>
  </poperty>
  <poperty index="test_query_formatter" connect="ep_account" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="false" is-select="true">
    <sql is-select="true" tables="mytest_log" fetch-zero-err="true">select * from mytest_log where 9=9</sql>
  </poperty>
  <poperty index="mytest_insert" connect="ep_account" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql repeat="source" repeat-concat="^" params="record_id|ep_user_id|amount|type|source|status|ctime|ictime|remark" is-select="false" tables="mytest" fetch-zero-err="true">insert into mytest(record_id,ep_user_id,amount,type,source,status,ctime,ictime,remark) value ($[record_id],$[ep_user_id],$[amount],$[type],$[source],$[status],'$[ctime]','$[ictime]','$[remark]')</sql>
    <sql params="record" is-select="false" tables="mytest_log" fetch-zero-err="true">insert into mytest_log(epuad_id,record,ctime) value ({mytest.LAST_INSERT_ID},'$[record]',now())</sql>
  </poperty>
  <poperty index="orderSignInsert" explain="订单签收成功，修改订单状态" connect="order" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql repeat="doid@orderid@signName@arrivalDate" repeat-split="@" repeat-concat="^" params="orderid" is-select="false" tables="orders" fetch-zero-err="true">update orders set order_status_id=20 where order_id=$[orderid]</sql>
    <sql repeat="doid@orderid@signName@arrivalDate" repeat-split="@" repeat-concat="^" params="orderid|signName" is-select="false" tables="order_transaction_logs" fetch-zero-err="true">insert into order_transaction_logs(order_id,transaction_operator,operate_type,log_type,transaction_description,operate_date) values('$[orderid]','$[signName]',20,0,'用户签收，订单完成',NOW())</sql>
  </poperty>
  <poperty index="orderBillsnoUpdate" explain="修改订单运单号" connect="order" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="true" is-select="false">
    <sql repeat="transferid@doid@ecName" repeat-split="@" repeat-concat="^" params="transferid|ecName|doid" is-select="false" tables="order_shipments" fetch-zero-err="true">update order_shipments set bills_no='$[transferid]',ec_name='$[ecName]' where shipment_id='$[doid]'</sql>
  </poperty>
  <poperty index="test_query" connect="ep_account" file="/target/test-classes/cn/test/zjs.sql.xml" is-master="false" is-select="true">
    <sql params="source|ep_user_id" is-select="true" tables="mytest" fetch-zero-err="true">select *,source as src from mytest ep where ep.source=$[source] and ep.`ep_user_id`=$[ep_user_id] and 9=9</sql>
    <result-formatter>
      <date-formatter result-key="ctime,ictime" date-style="yyyy-MM-dd HH:mm:ss,yyyy/MM/dd"></date-formatter>
      <prop-formatter result-key="status" prop-key="test"></prop-formatter>
      <key-value-formatter result-key="epuad_id" format-index="test_query_formatter" format-key="epuad_id" format-columns="record,ctime"></key-value-formatter>
    </result-formatter>
  </poperty>
</sql-config-debug>
